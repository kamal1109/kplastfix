(window.webpackJsonp=window.webpackJsonp||[]).push([[257],{"8Rai":function(t,e,s){"use strict";s.d(e,"a",(function(){return c}));var i=s("q1tI"),n=s("efOF"),a=s("R5JZ");function c(t){const{click:e,mouseDown:s,touchEnd:c,touchStart:o,handler:r,reference:h,ownerDocument:u=document}=t,l=Object(i.useRef)(null),d=Object(i.useRef)(new n.a("timestamp").timeStamp);return Object(i.useLayoutEffect)(()=>{const t={click:e,mouseDown:s,touchEnd:c,touchStart:o},i=h?h.current:l.current;return Object(a.a)(d.current,i,r,u,t)},[e,s,c,o,r]),h||l}},F5tS:function(t,e,s){t.exports={list:"list-1SW01aI4",fullBorder:"fullBorder-1SW01aI4",user:"user-1SW01aI4",hidden:"hidden-1SW01aI4"}},Owz1:function(t,e,s){t.exports={user:"user-3VULC5OX",userImage:"userImage-3VULC5OX",userName:"userName-3VULC5OX",active:"active-3VULC5OX",online:"online-3VULC5OX"}},R5JZ:function(t,e,s){"use strict";function i(t,e,s,i,n){function a(n){if(t>n.timeStamp)return;const a=n.target;void 0!==s&&null!==e&&null!==a&&a.ownerDocument===i&&(e.contains(a)||s(n))}return n.click&&i.addEventListener("click",a,!1),n.mouseDown&&i.addEventListener("mousedown",a,!1),n.touchEnd&&i.addEventListener("touchend",a,!1),n.touchStart&&i.addEventListener("touchstart",a,!1),()=>{i.removeEventListener("click",a,!1),i.removeEventListener("mousedown",a,!1),i.removeEventListener("touchend",a,!1),i.removeEventListener("touchstart",a,!1)}}s.d(e,"a",(function(){return i}))},tHaM:function(t,e,s){"use strict";s.r(e);var i=s("q1tI"),n=s.n(i),a=s("TSYQ"),c=s.n(a),o=s("hbEN"),r=s("A3Fa"),h=s("dTSQ"),u=s("/3z9"),l=s("Vdly"),d=s("wVAQ");class m{constructor(){this._list=[],this._cache={},this._cacheTimeout=null,window.loginStateChange.subscribe(this,()=>{window.is_authenticated||(this._list=[])}),this._list=l.getJSON("chat.suggest_list")||[],this._cache={}}async fetchItems(t){if(""===t)return[];const e=await Object(d.fetch)("/username_hint/?s="+t);if(e.ok){const t=await e.json();return this._addToCache(t),t.filter(t=>!t.inactive)}return[]}async getList(t){const e=t?this._list.filter(t):this._list;if(e.length){const t=e.map(t=>t.id);return this._getFromCache(t)}return[]}onUserSelect(t){if(window.user.id===t.id||window.user.username===t.username)return;const e=this._list.map(t=>t.id).indexOf(t.id);e>=0?(this._list.splice(e,1),this._list.unshift({id:t.id,username:t.username})):this._addUser(t),l.setJSON("chat.suggest_list",this._list)}static getUserChatSuggestListHandler(){return this._instance=this._instance||new m,this._instance}_mapCacheToIds(t){const e=[];return t.forEach(t=>{const s=this._cache[t];s&&e.push(s)}),e}async _getFromCache(t){if(!t.every(t=>t in this._cache)){const e=t.map(t=>encodeURIComponent("ids[]")+"="+encodeURIComponent(t)).join("&"),s=await Object(d.fetch)("/username_hint/?"+e);if(s.ok){const e=await s.json();return this._addToCache(e),this._mapCacheToIds(t)}return[]}return this._mapCacheToIds(t)}_addToCache(t){0!==t.length&&(t.forEach(t=>this._cache[t.id]=t),this._cacheTimeout&&clearTimeout(this._cacheTimeout),this._cacheTimeout=setTimeout(()=>{this._cache={}},12e4))}_addUser(t){
this._list.length>=20&&(this._list.shift(),delete this._cache[t.id]),this._list.unshift({id:t.id,username:t.username}),t&&(this._cache[t.id]=t)}}m._instance=null;var p=s("Eyy1"),_=s("Owz1"),g=s.n(_);function v(t){const{onItemSelected:e,index:s,item:i,isActiveListItem:a,setActiveItemIndex:o}=t;return n.a.createElement("li",{className:c()(g.a.user,i.online&&g.a.online,a&&g.a.active),onMouseDown:t=>{t.preventDefault(),e(i)},onMouseEnter:()=>{o(s)}},n.a.createElement("img",{className:g.a.userImage,src:i.userpic,alt:i.username}),n.a.createElement("span",{className:g.a.userName},i.username))}var I=s("RgaO"),f=s("F5tS");s.d(e,"UsernameHintList",(function(){return S})),s.d(e,"getUserChatSuggestListHandler",(function(){return w}));class S extends n.a.PureComponent{constructor(t){super(t),this._componentElemRef=n.a.createRef(),this._eventsBound=!1,this._debouncedGetSuggestions=Object(o.default)(()=>{this._getSuggestions()},500),this._changePositionPatched=()=>{this._componentElemRef.current&&(this.props.setPosition?this.props.setPosition(this._componentElemRef.current):this._setDropdownPosition())},this._setActiveItemIndex=t=>{this.setState({activeItemIndex:t})},this._getSuggestions=()=>{const t=this._getInputText(),e=this._getSuggestString(t);""!==e?e!==this.state.query&&("@"!==e?this._getSuggestionsList(e):this.props.simpleMode||this._suggestLastUsed()):this._closeList()},this._onItemSelectedPatched=t=>{this._closeList(),this._chatSuggestHandler.onUserSelect(t);const e=this._getUpdatedInputTextData(t.username);this.props.onItemSelected(t,e.text,e.cursorPosition)},this._handleKeyDown=t=>{switch(Object(u.hashFromEvent)(t)){case 38:case 40:case 13:case 27:this._isVisible()&&t.preventDefault()}},this._handleKeyUp=t=>{switch(Object(u.hashFromEvent)(t)){case 38:case 40:case 13:case 27:break;default:this._debouncedGetSuggestions()}},this._handleContainerKeyDown=t=>{switch(Object(u.hashFromEvent)(t)){case 38:this.state.reversed?this._selectNextItem():this._selectPrevItem();break;case 40:this.state.reversed?this._selectPrevItem():this._selectNextItem();break;case 13:t.preventDefault(),-1!==this.state.activeItemIndex&&this._onItemSelectedPatched(this.state.items[this.state.activeItemIndex]);break;case 27:this._closeList()}},this.state={container:this.props.container,input:this.props.input,query:"",items:[],activeItemIndex:-1,reversed:!1,top:0,left:0},this._chatSuggestHandler=m.getUserChatSuggestListHandler()}componentDidMount(){this._bindEvents()}componentDidUpdate(t,e){if(this.state.input&&this.state.container){if(this._bindEvents(),!this._isVisible())return this.state.container.removeEventListener("keydown",this._handleContainerKeyDown),void(this.props.simpleMode||this.state.input.removeEventListener("scroll",this._changePositionPatched));this.props.simpleMode||this.state.input.addEventListener("scroll",this._changePositionPatched),this._changePositionPatched(),0===e.items.length&&this.state.container.addEventListener("keydown",this._handleContainerKeyDown)}}render(){
if(!this.state.input||!this.state.container)return n.a.createElement(n.a.Fragment,null);const t=this.state.items.map((t,e)=>n.a.createElement(v,{key:e,index:e,isActiveListItem:e===this.state.activeItemIndex,item:t,onItemSelected:this._onItemSelectedPatched,setActiveItemIndex:this._setActiveItemIndex}));return n.a.createElement(I.a,{handler:()=>{this._isVisible()&&(this.props.onMouseDownOutside&&this.props.onMouseDownOutside(),this.props.closeOnMouseOutClick&&this._closeList())},click:!0},e=>(this._componentElemRef=e,n.a.createElement("ul",{ref:e,className:c()(f.list,0===this.state.items.length&&f.hidden,this.props.fullBorder&&f.fullBorder,this.props.className),style:{top:this.state.top,left:this.state.left}},this.state.reversed?t.reverse():t)))}componentWillUnmount(){const t=this.state.input;t&&(t.removeEventListener("click",this._getSuggestions),t.removeEventListener("keydown",this._handleKeyDown),t.removeEventListener("keyup",this._handleKeyUp));const e=this.state.container;e&&e.removeEventListener("keydown",this._handleContainerKeyDown)}setContainer(t){this.setState({container:t})}setInput(t){this.setState({input:t})}_bindEvents(){if(this._eventsBound||!this.state.input||!this.state.container)return;const t=this.state.input;t.addEventListener("click",this._getSuggestions),t.addEventListener("keydown",this._handleKeyDown),t.addEventListener("keyup",this._handleKeyUp),this._eventsBound=!0}_getSuggestString(t){if(t.length<=0)return"";if("@"===t)return"@";const e=t.lastIndexOf("@")+1;return e>1&&!/\s/.test(t[e-2])?"":t.substring(e)}async _suggestLastUsed(){const t=(await this._chatSuggestHandler.getList()).slice(0,this.props.maxItems);this.setState({items:t,activeItemIndex:0===t.length?-1:0})}async _getSuggestionsList(t){const e=t.split("").map(h.regExpEscape).join(".*"),s=new RegExp(e,"i"),i=this.props.maxItems||10,n=this.props.suggestLimit||10,a=await this._chatSuggestHandler.getList(t=>s.test(t.username));if(a.length>=n){const t=a.slice(0,i);this.setState({items:t,activeItemIndex:0===t.length?-1:0})}else if(t!==this.state.query){const e=(await this._chatSuggestHandler.fetchItems(t)).slice(0,i);this.setState({query:t,items:e,activeItemIndex:0===e.length?-1:0})}}_isVisible(){return 0!==this.state.items.length}_selectNextItem(){0!==this.state.items.length?this.state.activeItemIndex!==this.state.items.length-1?this._setActiveItemIndex(this.state.activeItemIndex+1):this._setActiveItemIndex(0):this._setActiveItemIndex(-1)}_selectPrevItem(){0!==this.state.items.length?this.state.activeItemIndex<=0?this._setActiveItemIndex(this.state.items.length-1):this._setActiveItemIndex(this.state.activeItemIndex-1):this._setActiveItemIndex(-1)}_closeList(){this.setState({query:"",activeItemIndex:-1,items:[]})}_getInputText(){const t=Object(p.ensureNotNull)(this.state.input);return this.props.simpleMode?t.value:this._getQueryFromInputField()}_getQueryFromInputField(){const t=Object(p.ensureNotNull)(this.state.input),e=t.value,s=t.selectionStart||0,i=e.slice(0,s).lastIndexOf("@",s),n=e.slice(i,s)
;return i<0||i>0&&e[i-1].match(/[\S]+/)||n.search(/\s/)>=0?"":n}_setDropdownPosition(){if(!this._componentElemRef.current)return;const t=this._componentElemRef.current,e=Object(p.ensureNotNull)(this.state.input),s=Object(p.ensureNotNull)(this.state.container),i=r.Caret.getRelativePosition(e),n=e.getBoundingClientRect(),a=s.getBoundingClientRect(),c=a.height,o=a.top,h=s.scrollTop,u=i.top,l=t.clientHeight,d=n.top-o,m=e.scrollTop,_=d+u-h-m,g=c-_;let v,I,f;const S=u<=m+n.height&&u>m;if(!this.props.simpleMode&&!S)return void this._closeList();l<g?(v=!1,I=_+20):(v=!0,I=_-l);const w=a.width,E=a.left,x=i.left,L=t.clientWidth,y=n.left-E+x,b=y+L-w;f=b>0?y-b:y,this.setState({reversed:v,left:f,top:I})}_getUpdatedInputTextData(t){const e=Object(p.ensureNotNull)(this.state.input),s=e.value,i=e.selectionStart,n=s.lastIndexOf("@",i||void 0),a=/\s/.exec(s.substring(n));let c="@"+t;a||(c+=" ");let o="";a&&(o=s.slice(n+a.index));const r=s.slice(0,n)+c;return{text:r+o,cursorPosition:r.length+1}}}const w=m.getUserChatSuggestListHandler}}]);