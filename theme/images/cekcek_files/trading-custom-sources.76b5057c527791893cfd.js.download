(window.webpackJsonp=window.webpackJsonp||[]).push([["trading-custom-sources"],{"//HS":function(t,e,o){"use strict";o.d(e,"a",(function(){return r}));var i=o("jFln");function r(t,e,o,r,s,l,a){t.save(),t.strokeStyle=r;const n=t.lineWidth%2?.5:0;t.translate(e+n,o+n),s&&t.scale(1,-1),Object(i.drawArrow)(t,0,0,0,l,a),t.restore()}},EgV8:function(t,e,o){"use strict";o.r(e);var i=o("oV8k"),r=o("Kxc7"),s=o("Eyy1"),l=o("HGP3"),a=o("Y7w9"),n=o("XPit"),c=o("k9/m"),d=o("VdBB"),h=o("//HS");class u{constructor(){this._data={points:[],arrowHeight:0}}setData(t){this._data=t}hitTest(t){for(const e of this._data.points){const o=Math.round(e.x),i=Math.round(e.y),r=4;let s,l;if(e.arrowUp?(s=i,l=i+this._data.arrowHeight):(s=i-this._data.arrowHeight,l=i),t.x>=o-2&&t.x<=o+2&&t.y>=s&&t.y<=l&&""!==e.tooltip)return new d.HitTestResult(d.HitTestResult.CUSTOM,{tooltip:{text:e.tooltip,rect:{x:o-2,y:s,w:r,h:l-s}}})}return null}draw(t,e){const o=e.pixelRatio;t.save(),t.lineWidth=Math.max(1,Math.floor(t.lineWidth*o));const i=Math.max(1,Math.round(4*o)),r=Math.max(1,Math.round(this._data.arrowHeight*o));for(const s of this._data.points){const e=Math.round((s.x-2)*o),l=Math.round(s.y*o);Object(h.a)(t,e,l,s.arrowColor,!s.arrowUp,r,i)}t.restore()}}const _=l.colorsPalette["color-tv-blue-500"],b=l.colorsPalette["color-ripe-red-500"];class p{constructor(t,e){this._invalidated=!0,this._points=[],this._renderer=new u,this._chartModel=t,this._source=e}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}_updateImpl(){this._points=[],this._renderer.setData({points:[],arrowHeight:0});const t=this._chartModel.timeScale().visibleBarsStrictRange();if(null===t)return;const e=this._source.points();if(0===e.length)return;const o=Object(a.lowerbound)(e,t.firstBar(),(t,e)=>t.index<e,0),i=Object(a.upperbound)(e,t.lastBar(),(t,e)=>e.index>t,o);if(o>=i)return;const r=this._chartModel.mainSeries().priceScale().isInverted(),l=new Map;for(let a=o;a<i;a++){const t=e[a],o=l.get(t.index)||m(r);if(void 0===o.x){const e=this._getXCoordinate(t.index);if(null===e)continue;o.x=e}const i=t.isBuyDirection!==r,n=i?"arrowUp":"arrowDown",c=i?1:-1,d=o[n].y;if(void 0===d){const e=this._getYCoordinate(t.index,t.isBuyDirection);if(null===e)continue;o[n].y=e+11*c}else o[n].y=d+19*c;l.set(t.index,o),this._points.push({x:Object(s.ensureDefined)(o.x),y:Object(s.ensureDefined)(o[n].y),arrowUp:i,arrowColor:o[n].color,tooltip:t.tooltip})}this._renderer.setData({points:this._points,arrowHeight:8})}_getXCoordinate(t){const e=this._chartModel.mainSeries().bars().lastIndex();return null===e||t>e?null:this._chartModel.timeScale().indexToCoordinate(t)}_getYCoordinate(t,e){let o=null;const i=this._chartModel.mainSeries(),r=i.priceSource(),s=null!==r?r:e?"low":"high",l=Object(n.barFunction)(s),a=i.nearestData(t,c.PlotRowSearchMode.NearestLeft);if(void 0!==a){const t=l(a.value);if(!Number.isNaN(t)){const e=i.firstValue();null!==e&&(o=this._chartModel.mainSeries().priceScale().priceToCoordinate(t,e))}}return o}}function m(t){let e,o
;return t?(e=b,o=_):(e=_,o=b),{x:void 0,arrowUp:{y:void 0,color:e},arrowDown:{y:void 0,color:o}}}o.d(e,"ExecutionsSource",(function(){return v}));class v extends i.a{constructor(t,e,o,i,r){super(t,e),this._paneViews=[],this._executionsPointsManager=r,this._executionsPointsManager.existingPointsChanged().subscribe(this,this.updateAllViews),this._showExecutions=i,this._paneViews.push(new p(e,this))}destroy(){this._executionsPointsManager.existingPointsChanged().unsubscribeAll(this),this._executionsPointsManager.destroy(),this._showExecutions.destroy()}points(){return this._executionsPointsManager.existingPoints()}updateAllViews(){if(this._showExecutions.value())for(const t of this._paneViews)t.update()}paneViews(t){return t.containsMainSeries()?window.TradingView.printing&&!r.enabled("snapshot_trading_drawings")?[]:this._showExecutions.value()?this._paneViews:[]:[]}}},KSBC:function(t,e,o){"use strict";o.r(e),o.d(e,"ExecutionsPointsManager",(function(){return a}));var i=o("Y7w9"),r=o("aIyQ"),s=o.n(r);function l(t){return void 0!==t.index}class a{constructor(t,e,o){this._points=[],this._existingExecutionPointsCache=null,this._offsetOfFirstExistingPoint=null,this._existingPointsChanged=new s.a,this._pointsets=[],this._pointsetManagerFactory=e,this._firstSeriesTimePointWV=o,this._firstSeriesTimePointWV.subscribe(this._updateExistingPoints.bind(this)),this._executionsService=t,this._addPoints(this._executionsService.executions()),this._executionsService.executionsAdded().subscribe(this,this._addPoints),this._executionsService.executionsCleared().subscribe(this,this._clearPoints)}destroy(){this._clearPoints(),this._firstSeriesTimePointWV.destroy(),this._executionsService.executionsAdded().unsubscribeAll(this),this._executionsService.executionsCleared().unsubscribeAll(this),this._executionsService.destroy()}existingPoints(){return null===this._offsetOfFirstExistingPoint?[]:(null===this._existingExecutionPointsCache&&(this._existingExecutionPointsCache=this._points.slice(this._offsetOfFirstExistingPoint).filter(l)),this._existingExecutionPointsCache)}existingPointsChanged(){return this._existingPointsChanged}_onExistingStartPointChanged(){this._existingExecutionPointsCache=null,this._existingPointsChanged.fire(this.existingPoints())}_addPoints(t){if(0===t.length)return;const e=function(t){return t.map(t=>({time_t:Math.round(t.time/1e3),index:void 0,isBuyDirection:1===t.side,tooltip:t.tooltip}))}(t);e.sort((t,e)=>t.time_t-e.time_t);let o=0;const r=this._points.length>0;r&&(o=Object(i.upperbound)(this._points,e[0].time_t,(t,e)=>e.time_t>t,0)),this._points=this._points.slice(0,o).concat(e).concat(this._points.slice(o));const s=this._firstSeriesTimePointWV.value();null!==this._offsetOfFirstExistingPoint&&null!==s&&e[0].time_t<s?this._offsetOfFirstExistingPoint=this._offsetOfFirstExistingPoint+e.length:((null===this._offsetOfFirstExistingPoint||e[0].time_t<this._points[this._offsetOfFirstExistingPoint].time_t)&&(this._offsetOfFirstExistingPoint=this._calcOffsetOfFirstExistingPoint()),
null!==this._offsetOfFirstExistingPoint&&(r?o>=this._offsetOfFirstExistingPoint&&this._sendPointsToServer(o,o+e.length):this._sendPointsToServer(this._offsetOfFirstExistingPoint,this._points.length)))}_updateExistingPoints(){const t=this._calcOffsetOfFirstExistingPoint();null!==t&&(null===this._offsetOfFirstExistingPoint&&(this._offsetOfFirstExistingPoint=this._points.length),t<this._offsetOfFirstExistingPoint&&(this._sendPointsToServer(t,this._offsetOfFirstExistingPoint),this._offsetOfFirstExistingPoint=t))}_clearPoints(){for(const t of this._pointsets)t.onUpdate().unsubscribeAll(this),t.destroy();this._pointsets=[],this._points=[],this._offsetOfFirstExistingPoint=null,this._onExistingStartPointChanged()}_sendPointsToServer(t,e){const o=this._points.slice(t,e).map(t=>({time_t:t.time_t,offset:0}));if(0===o.length)return;const i=this._pointsetManagerFactory(o);null!==i&&(i.onUpdate().subscribe(this,this._updatePointsFromServer),this._pointsets.push(i))}_updatePointsFromServer(t){if(null===this._offsetOfFirstExistingPoint)return;const e=Object(i.lowerbound)(this._points,t[0].time_t,(t,e)=>t.time_t<e,this._offsetOfFirstExistingPoint);let o=Math.max(this._offsetOfFirstExistingPoint,e);for(const i of t)for(let t=o;t<this._points.length&&(o=t,!(this._points[t].time_t>i.time_t));t++)this._points[t].time_t===i.time_t&&(this._points[t].index=i.index);this._onExistingStartPointChanged()}_calcOffsetOfFirstExistingPoint(){const t=this._firstSeriesTimePointWV.value();return null===t?null:Object(i.upperbound)(this._points,t,(t,e)=>e.time_t>t,0,this._offsetOfFirstExistingPoint||this._points.length)}}},ZvFF:function(t,e,o){"use strict";o.r(e);var i=o("Eyy1"),r=o("ogJP"),s=o("QfUd"),l=o("txPx"),a=o("Cf1E"),n=o("vTIA"),c=o("GOhO"),d=o("oV8k"),h=o("Kxc7"),u=o("mrSG"),_=o("ivNn"),b=o("aO4+"),p=o("7KDR"),m=o("5VQP"),v=o("2uTr");async function P(t,e){const o=function(t){const e=[],o=t.modifyOrder;void 0!==o&&e.push(new p.Action({label:y,statName:"Edit Order",onExecute:()=>o("Chart Order Context Menu")}));const i=t.cancelOrder;void 0!==i&&e.push(new p.Action({label:C,statName:"Cancel Order",onExecute:()=>i("Chart Order Context Menu")}));return e}(t);return m.ContextMenuManager.createMenu(o,{}).then(t=>(t.show(e),t))}const y=Object(v.appendEllipsis)(window.t("Modify Order")),C=window.t("Cancel Order");var g=o("cUJV"),x=o("3+Gi"),w=o("0W4x");const f=window.t("Trailing Stop"),k=window.t("Stop Loss"),S=window.t("Take Profit");class O{constructor(t,e,o,i,r,s,l=!1){this._data=null,this._callbacks={},this._quantityFormatter=new g.a,this._inEdit=!1,this._id=t,this._source=o,this._mainSeries=i,this.setData(e),this._symbolDataProvider=r,this._symbolDataProvider.onStatusChanged.subscribe(this,this._updateQtyFormatter),this._updateQtyFormatter(),this._exitTrackingMode=s,this._isStopLimit=l}destroy(){this._symbolDataProvider.onStatusChanged.unsubscribeAll(this)}data(){return Object(i.ensureNotNull)(this._data)}setData(t){if(this._inEdit)return;const{callbacks:e={},mainType:o}=t,i=Object(u.d)(t,["callbacks","mainType"]);this._callbacks=e,this._data=i}
id(){return this._id}price(){return Object(i.ensureNotNull)(this._data).price}qtyText(){const t=Object(i.ensureNotNull)(this._data);return this._quantityFormatter.format(t.considerFilledQty?t.qty-(t.filledQty||0):t.qty)}text(){const t=Object(i.ensureNotNull)(this._data);if(this.isBracket()){const i=(e=t.type,o=t.stopType,3===e?o===x.a.TrailingStop?f:k:1===e?S:null);if(null!==i)return i}var e,o;return`${Object(w.sideToText)(t.side)} ${Object(w.orderTypeToText)(t.type)}`}type(){return Object(i.ensureNotNull)(this._data).type}isActive(){return Object(i.ensureNotNull)(this._data).isActive}isBuyDirection(){return 1===Object(i.ensureNotNull)(this._data).side}supportModify(){return Boolean(this._callbacks.modifyOrder)}async onModify(t="Chart Order"){this._source.setIsBlocked(!0);const e=Object(r.clone)(Object(i.ensureNotNull)(this._data));await this._addTrailingStopPipsData(e),await Object(i.ensureDefined)(this._callbacks.modifyOrder)(t,e.id,e,this._isStopLimit),this._source.setIsBlocked(!1),this._source.syncData()}supportMove(){return Boolean(this._callbacks.moveOrder)}async onMove(t){this._inEdit=!0;const e=new b.Point(t.localX,t.localY),o=this._mainSeries.priceScale(),r=this._mainSeries.firstValue();if(null===r)return;const s=1/this._mainSeries.base(),l=Object(i.ensureNotNull)(this._data),a=o.coordinateToPrice(e.y,r);l.price=Object(_.fixComputationError)(s*Math.round(a/s)),t.isTouch&&this._exitTrackingMode(),this._source.redraw()}async onFinishMove(){this._source.setIsBlocked(!0);const t=Object(r.clone)(Object(i.ensureNotNull)(this._data));if(this._isStopLimit)t.limitPrice=Object(i.ensureNotNull)(this._data).price;else{const e=t.price;t.stopPrice?t.stopPrice=e:t.limitPrice&&(t.limitPrice=e)}await this._addTrailingStopPipsData(t),await Object(i.ensureDefined)(this._callbacks.moveOrder)("Chart Order",t.id,t,this._isStopLimit),this._inEdit=!1,this._source.setIsBlocked(!1),this._source.syncData()}supportCancel(){return!this._isStopLimit&&Boolean(this._callbacks.cancelOrder)}async onCancel(t="Chart Order"){this._source.isBlocked()||(this._source.setIsBlocked(!0),await Object(i.ensureDefined)(this._callbacks.cancelOrder)(t,Object(i.ensureNotNull)(this._data).id),this._source.setIsBlocked(!1),this._source.syncData())}hasContextMenu(){return null!==this._data&&(this.supportModify()||this.supportCancel()||this.supportMove())}onContextMenu(t){if(null!==this._data){const e={};this.supportCancel()&&(e.cancelOrder=this.onCancel.bind(this)),this.supportModify()&&(e.modifyOrder=this.onModify.bind(this)),P(e,t)}}isBracket(){const t=Object(i.ensureNotNull)(this._data);if(!t.parentId)return!1;const e=this._source.mainItem();return 1!==t.parentType||void 0!==e&&function(t,e){const o=t.data();if(o.side===e.side)return!1;const r=Object(i.ensureDefined)(o.limitPrice||o.stopPrice),s=Object(i.ensureDefined)(e.limitPrice||e.stopPrice);if(1===o.side){if(1===e.type&&s<r||3===e.type&&s>r)return!1}else if(1===e.type&&s>r||3===e.type&&s<r)return!1;return!0}(e,t)}async _updateQtyFormatter(){if(null===this._data)return Promise.resolve()
;this._quantityFormatter=await this._symbolDataProvider.quantityFormatter(this._data.symbol),this._source.redraw()}async _addTrailingStopPipsData(t){if(t.parentId&&t.stopType===x.a.TrailingStop){const e=Object(i.ensureDefined)(this._source.mainItem()),{pipSize:o}=await this._symbolDataProvider.symbolInfo(t.symbol),{bid:r,ask:s}=await this._symbolDataProvider.quotesSnapshot(t.symbol),{side:l,type:a,stopPrice:n,limitPrice:c}=e.data();let d;d=e instanceof O?3===a?n:c:1===l?r:s,t.trailingStopPips=(Object(i.ensureDefined)(t.stopPrice||t.limitPrice)-d)/o*(1===l?-1:1)}return t}}var I=o("Tmoa"),T=o("jFln"),M=o("ikwP"),D=o("zDbI"),j=o("VdBB"),L=o("//lt"),A=o("gAom"),N=o("u+0B"),R=o("XlJ7");function E(t,e,o,i,r,s,l,a){t.save(),t.textAlign="center",t.textBaseline="middle",t.fillStyle=l,t.font=a,t.translate(i,r+s),Object(M.drawScaled)(t,e,()=>{t.fillText(o,0,0)}),t.restore()}function V(t,e,o,i,r,s){t.save(),t.fillStyle=s,t.fillRect(e,o,i,r),t.restore()}let B;class W{constructor(){this._data=null,this._height=19,this._heightBody=19,this._bodyBorderRadius=2,this._prevPixelRatio=null,this._font=null,this._textWidthCache=new N.TextWidthCache,this._cache=null,this._wasSourceMoved=!1}setData(t){var e;const o=(null===(e=this._data)||void 0===e?void 0:e.fontSize)||null,i=(null==t?void 0:t.fontSize)||null;this._data=t,o!==i&&(this._textWidthCache.reset(),this._font=null===i?null:Object(R.makeFont)(i,D.CHART_FONT_FAMILY,"","normal")),this._cache=null}hitTest(t,e){if(null===this._data)return null;const o=e.pixelRatio,i=this._cachedCoordinates(e),r=Math.round(t.x*o),s=Math.round(t.y*o),l=r>=i.body.left,a=r<=i.body.right,n=l&&a;if(!(s>=i.top&&s<=i.bottom)||!n)return null;const c={cursorType:L.PaneCursorType.Default,hideCrosshairLinesOnHover:!0,activeItem:{id:this._data.id,part:4}};if(this._data.disabled)return new j.HitTestResult(j.HitTestResult.CUSTOM,c);let d={};if(void 0!==this._data.callbacks.onMove){const t=t=>{var e;(null===(e=this._data)||void 0===e?void 0:e.callbacks.onMove)&&this._data.callbacks.onMove(t),this._wasSourceMoved=!0},e=()=>{var t;this._wasSourceMoved&&(null===(t=this._data)||void 0===t?void 0:t.callbacks.onFinishMove)&&this._data.callbacks.onFinishMove(),this._wasSourceMoved=!1};d={activeItem:{id:this._data.id,part:4},cursorType:L.PaneCursorType.Pointer,pressedMouseMoveHandler:t,touchMoveHandler:t,mouseUpHandler:e,touchEndHandler:e}}const h=this._data.callbacks.onContextMenu,u=Object.assign(Object.assign(Object.assign({},c),d),{contextMenuHandler:h}),_=Math.round(i.body.left/o),b=Math.round(i.top/o);if(l&&r<i.text.left&&void 0!==this._data.callbacks.onModify){const t=Math.round(i.text.left/o);return new j.HitTestResult(j.HitTestResult.CUSTOM,Object.assign(Object.assign({},u),{activeItem:{id:this._data.id,part:1},cursorType:L.PaneCursorType.Default,clickHandler:this._data.callbacks.onModify,tapHandler:this._data.callbacks.onModify,tooltip:{extendMargin:!0,text:this._data.qty.title,rect:{x:_,y:b,w:t-_,h:this._height}}}))}if(r>=i.close.left&&a&&void 0!==this._data.callbacks.onClose){
const t=Math.round(i.body.right/o),e=Math.round(i.close.left/o);return new j.HitTestResult(j.HitTestResult.CUSTOM,Object.assign(Object.assign({},u),{activeItem:{id:this._data.id,part:2},cursorType:L.PaneCursorType.Default,clickHandler:this._data.callbacks.onClose,tapHandler:this._data.callbacks.onClose,tooltip:{extendMargin:!0,text:this._data.close.title,rect:{x:e,y:b,w:t-e,h:this._height}}}))}return new j.HitTestResult(j.HitTestResult.CUSTOM,u)}drawBackground(t,e){null===this._data||this._data.line.active.visible||this._drawLinesWithBackground(t,e)}draw(t,e){if(null===this._data)return;const o=e.pixelRatio,i=this._cachedCoordinates(e);if(!this._isDataVisibleInViewport(e))return;this._data.line.active.visible&&this._drawLinesWithBackground(t,e);const r=i.body.right-i.body.left,s=i.body.bottom-i.body.top,l=i.body.top+i.borderWidth,a=s-2*i.borderWidth,n=i.borderRadius-i.borderWidth;Object(A.drawRoundRectWithInnerBorder)(t,i.body.left,i.body.top,r,s,"transparent",i.borderRadius,i.borderWidth,this._data.borderColor,this._data.borderStyle);const c=(i.body.top+i.body.bottom)/2;let d=i.body.left+i.borderWidth;const h=0!==i.text.width,u=0!==i.close.width;if(0!==i.qty.width){const e=this._data.qty.active,r=h||u?[n,0,0,n]:n;Object(A.drawRoundRectWithInnerBorder)(t,i.qty.left,l,i.qty.width,a,this._data.qty.backgroundColor,r),e.visible&&Object(A.drawRoundRectWithInnerBorder)(t,i.qty.left,l,i.qty.width,a,e.backgroundColor,r);const s=i.qty.left+i.qty.width/2;this._drawQuantityText(t,o,s,c),d+=i.qty.width,V(t,d,l,i.borderWidth,a,this._data.qty.dividerColor),d+=i.borderWidth}if(h){const e=u?0:[0,n,n,0];Object(A.drawRoundRectWithInnerBorder)(t,i.text.left,l,i.text.width,a,this._data.text.backgroundColor,e);const r=i.text.left+i.text.width/2;this._drawBodyText(t,o,r,c),d+=i.text.width,V(t,d,l,i.borderWidth,a,this._data.text.dividerColor),d+=i.borderWidth}if(u){const e=i.body.right-d-i.borderWidth,r=this._data.close.active;Object(A.drawRoundRectWithInnerBorder)(t,d,l,e,a,this._data.close.backgroundColor,[0,n,n,0]),r.visible&&Object(A.drawRoundRectWithInnerBorder)(t,d,l,e,a,r.backgroundColor,[0,n,n,0]),this._drawCloseButton(t,o,d,i.body.top,i.close.width,s,i.borderWidth)}}_cachedCoordinates(t){const e=t.pixelRatio;return(null===this._cache||this._prevPixelRatio!==e||this._cache.cssWidth!==t.cssWidth)&&(this._prevPixelRatio!==e&&(this._textWidthCache.reset(),this._prevPixelRatio=e),B||function(){const t=document.createElement("canvas");t.width=0,t.height=0,B=Object(i.ensureNotNull)(t.getContext("2d"))}(),this._cache=this._calculateCache(t)),Object(i.ensureNotNull)(this._cache)}_calculateCache(t){const e=t.pixelRatio,o=Math.round(t.cssWidth*e),r=Object(i.ensureNotNull)(this._data),s=Math.max(1,Math.floor(1*e)),l=this._bodyBorderRadius,a=Math.max(l,Math.floor(l*e)),n=this._quantityWidth(B),c=Math.round(n*e),d=this._textWidth(B),h=Math.round(d*e),u=r.callbacks.onClose?this._closeWidth():0,_=Math.round(u*e),b=s*((n&&1)+(d&&1)),p=c+h+_+b+2*s,m=this._calcAllWidth(t.pixelRatio,c,h,_,b,s);let v=Math.round(this._heightBody*e)
;const P=Math.max(1,Math.floor(e));v%2!=P%2&&(v+=1);const y=Math.round(r.y*e),C=Math.floor(y+P/2-v/2)-Math.floor(.5*e),g=Math.round((this._height-this._heightBody)/2*e),x=C-g,w=v+2*g,f=o-m,k=Math.round(r.line.width*e),S=Math.max(k/100*o,1),O=Math.round(o-Math.min(f,S)),I=O-p,T=I+c+(c&&s)+(c&&s),M=T+h+(h&&s);return{borderWidth:s,borderRadius:a,cssWidth:t.cssWidth,yMid:y,top:x,bottom:x+w,left:0,right:o,body:{left:I,right:O,top:C,bottom:C+v},qty:{width:c,left:I+(c&&s)},text:{width:h,left:T},close:{width:_,left:M}}}_calcAllWidth(t,e,o,i,r,s){return e+o+i+r+2*s}_isDataVisibleInViewport(t){if(null===this._data)return!1;const e=Math.ceil(this._height/2);return this._data.y>=-e&&this._data.y<=t.cssHeight+e}_drawLinesWithBackground(t,e){const o=Object(i.ensureNotNull)(this._data),r=e.pixelRatio,s=this._cachedCoordinates(e),l=Math.round(e.physicalWidth);t.save(),t.strokeStyle=o.line.color,t.lineWidth=Math.max(1,Math.floor(o.line.thickness*r)),Object(T.setLineStyle)(t,o.line.style),Object(A.drawHorizontalLine)(t,s.yMid,s.body.right,l),o.line.extend&&Object(A.drawHorizontalLine)(t,s.yMid,0,s.body.left),t.restore()}_textWidth(t){const e=Object(i.ensureNotNull)(this._data);t.save(),t.font=Object(i.ensureNotNull)(this._font);const o=Math.ceil(this._textWidthCache.measureText(t,e.text.text));return t.restore(),o?Math.round(14+o):0}_closeWidth(){return 23}_drawBodyText(t,e,o,r){const s=Object(i.ensureNotNull)(this._data).text,l=this._textWidthCache.yMidCorrection(t,Object(i.ensureNotNull)(this._data).qty.text)*e;E(t,e,s.text,o,r,l,s.textColor,Object(i.ensureNotNull)(this._font))}_drawQuantityText(t,e,o,r){const s=Object(i.ensureNotNull)(this._data).qty,l=this._textWidthCache.yMidCorrection(t,s.text)*e;E(t,e,s.text,o,r,l,s.textColor,Object(i.ensureNotNull)(this._font))}_drawCloseButton(t,e,o,r,s,l,a){const n=Object(i.ensureNotNull)(this._data).close;t.save(),t.lineWidth=a,t.strokeStyle=n.iconColor;const c=r+l,d=Math.max(1,Math.ceil(7*e)),h=Math.round((s-d)/2),u=Math.round((l-d)/2);Object(T.drawPoly)(t,[new b.Point(o+h,r+u),new b.Point(o+h+d,c-u)],!0),Object(T.drawPoly)(t,[new b.Point(o+h+d,r+u),new b.Point(o+h,c-u)],!0),t.restore()}_quantityWidth(t){const e=Object(i.ensureNotNull)(this._data);t.save(),t.font=Object(i.ensureNotNull)(this._font);const o=Math.ceil(this._textWidthCache.measureText(t,e.qty.text));return t.restore(),Math.round(Math.max(this._height,14+o))}}var F=o("EBrf"),q=o("Ialn");function H(t){return null===t?"0":Object(q.forceLTRStr)(Object(F.splitThousands)(t," "))}class U{constructor(t,e,o,i){this._invalidated=!0,this._renderer=null,this._chartModel=t,this._tradedItem=e,this._source=o,this._styleGetter=i}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._renderer}priceToCoordinate(t){if(null===t)return null;const e=this._chartModel.mainSeries(),o=e.firstValue();return null===o?null:e.priceScale().priceToCoordinate(t,o)}isActiveItem(){return this._source.activeItemId()===this._tradedItem.id()}isActiveItemPart(t){
return this.isActiveItem()&&this._source.activePartItem()===t}isHoveredSource(){return this._chartModel.hoveredSource()===this._source}isSelectedSource(){return this._chartModel.selection().isSelected(this._source)}}const G=window.t("Modify Order..."),z=window.t("Cancel Order");class Q extends U{constructor(t,e,o,i,r){super(t,e,o,r),this._renderer=new W,this._showProperty=i}_updateImpl(){if(this._renderer.setData(null),!this._showProperty.value())return;const t=this.priceToCoordinate(this._tradedItem.price());if(null===t)return;const e=this._styleGetter(),o=this.isHoveredSource(),i=o&&this.isActiveItem(),r=(o||this.isSelectedSource())&&this.isActiveItem(),s=i&&this.isActiveItemPart(1),l=i&&this.isActiveItemPart(2),a=Object(I.generateColor)(e.borderColor,85);this._renderer.setData({fontSize:13,borderColor:e.borderColor,borderStyle:e.borderStyle,y:t,id:this._tradedItem.id(),disabled:this._source.isBlocked(),callbacks:this._callbacks(),line:{thickness:this._source.lineWidth(),width:this._source.lineLength(),style:e.lineStyle,color:e.lineColor,extend:this._source.isLineExtended(),active:{visible:r,backgroundColor:"trasparent"}},qty:{title:G,text:H(this._tradedItem.qtyText()),textColor:e.qty.textColor,backgroundColor:e.qty.backgroundColor,dividerColor:e.qty.dividerColor,active:{visible:s,backgroundColor:a}},text:{text:this._tradedItem.text(),textColor:e.text.textColor,backgroundColor:e.text.backgroundColor,dividerColor:e.text.dividerColor},close:{title:z,backgroundColor:e.close.backgroundColor,iconColor:e.close.iconColor,active:{visible:l,backgroundColor:a}}})}_callbacks(){const t={};return this._tradedItem.supportModify()&&(t.onModify=this._tradedItem.onModify.bind(this._tradedItem)),this._tradedItem.supportCancel()&&(t.onClose=this._tradedItem.onCancel.bind(this._tradedItem)),this._tradedItem.supportMove()&&(t.onMove=this._tradedItem.onMove.bind(this._tradedItem),t.onFinishMove=this._tradedItem.onFinishMove.bind(this._tradedItem)),this._tradedItem.hasContextMenu()&&(t.onContextMenu=this._tradedItem.onContextMenu.bind(this._tradedItem)),t}}async function Y(t,e){const o=function(t){const e=[];void 0!==t.modifyPosition&&e.push(new p.Action({label:K,statName:"Modify Position",onExecute:()=>Object(i.ensureDefined)(t.modifyPosition)("Chart Position Context Menu")}));void 0!==t.closePosition&&e.push(new p.Action({label:J,statName:"Close Position",onExecute:()=>Object(i.ensureDefined)(t.closePosition)("Chart Position Context Menu")}));void 0!==t.reversePosition&&e.push(new p.Action({label:X,statName:"Reverse Position",onExecute:()=>Object(i.ensureDefined)(t.reversePosition)("Chart Position Context Menu")}));return e}(t);return m.ContextMenuManager.createMenu(o,{}).then(t=>(t.show(e),t))}const K=Object(v.appendEllipsis)(window.t("Protect Position")),J=window.t("Close Position"),X=window.t("Reverse Position");var $=o("zXvd");const Z=Object(l.getLogger)("Trading.Positions");class tt{constructor(t,e,o,i,r){this._integerFormatter=new $.NumericFormatter(0),this._oneDecimalFormatter=new $.NumericFormatter(1),this._data=null,
this._symbolData={calculatePLUsingLast:!1,minTick:1,pipSize:1,quantityFormatter:null},this._last=null,this._currency=null,this._id=t,this._source=o,this._currencyGetter=r,this.setData(e),this._symbolDataProvider=i,this._updateLastHandler=this._updateLast.bind(this),this._symbolDataProvider.subscribeRealtime(e.symbol,this._updateLastHandler),this._symbolDataProvider.onStatusChanged.subscribe(this,this._updateSymbolData),this._updateSymbolData()}destroy(){const t=Object(i.ensureNotNull)(this._data);this._symbolDataProvider.unsubscribeRealtime(t.symbol,this._updateLastHandler),this._symbolDataProvider.onStatusChanged.unsubscribeAll(this)}data(){return Object(i.ensureNotNull)(this._data)}setData(t){const{callbacks:e,mainType:o}=t,i=Object(u.d)(t,["callbacks","mainType"]);this._callbacks=e,this._data=i}id(){return this._id}price(){return Object(i.ensureNotNull)(this._data).price}qty(){return Object(i.ensureNotNull)(this._data).qtyBySide}currency(){var t;return null!==(t=this._currency)&&void 0!==t?t:""}updateCurrency(t){null===this._currency&&(this._currency="",this._currencyGetter(t).then(t=>{this._currency=t,this._source.redraw()}))}isBuyDirection(){return 1===Object(i.ensureNotNull)(this._data).side}supportReverse(){return Object(i.ensureNotNull)(this._data).supportReverse}async onReverse(t){await this._doActionWithBlock("reversePosition",!0,t)}supportClose(){return Object(i.ensureNotNull)(this._data).supportClose}async onClose(t){await this._doActionWithBlock("closePosition",!0,t)}supportModify(){return Object(i.ensureNotNull)(this._data).supportBrackets}async onModify(t){await this._doActionWithBlock("modifyPosition",!1,t)}hasContextMenu(){return this.supportModify()||this.supportClose()||this.supportReverse()}onContextMenu(t){if(null!==this._data){const e={};this.supportClose()&&(e.closePosition=this.onClose.bind(this)),this.supportReverse()&&(e.reversePosition=this.onReverse.bind(this)),this.supportModify()&&(e.modifyPosition=this.onModify.bind(this)),Y(e,t)}}pl(){return Object(i.ensureNotNull)(this._data).pl}displayPl(){if(!this._source.isPositionPLVisible())return null;const{pl:t,side:e,avgPrice:o}=Object(i.ensureNotNull)(this._data);if(null===t)return null;const r=this._source.positionDisplayMode();if(r===n.PositionPLDisplay.Money)return 100*t/100||0;const{trade:s,ask:l,bid:a}=this._last||{},c=-1===e;let d=s;this._symbolData.calculatePLUsingLast||(d=c?l:a),d=Number(d||o);const h=(d-o)*(c?-1:1);if(r===n.PositionPLDisplay.Pips){const{pipSize:t,minTick:e}=this._symbolData,o=isFinite(t)&&t!==e?this._oneDecimalFormatter:this._integerFormatter;return parseFloat(o.format(h/(t||e)))}return h/o*100}profitState(){return Object(i.ensureNotNull)(this._data).profitState}_updateLast(t,e){var o,i,r;(this._symbolData.calculatePLUsingLast?(null===(r=this._last)||void 0===r?void 0:r.trade)!==e.trade:(null===(o=this._last)||void 0===o?void 0:o.ask)!==e.ask&&(null===(i=this._last)||void 0===i?void 0:i.bid)!==e.bid)&&(this._last={trade:e.trade||NaN,ask:e.ask||NaN,bid:e.bid||NaN},
this._source.positionDisplayMode()!==n.PositionPLDisplay.Money&&this._source.redraw())}async _updateSymbolData(){if(null===this._data)return;const[t,e]=await Promise.all([this._symbolDataProvider.symbolInfo(this._data.symbol),this._symbolDataProvider.quantityFormatter(this._data.symbol)]);this._symbolData.minTick=t.minTick,this._symbolData.pipSize=t.pipSize,this._symbolData.quantityFormatter=e;const o=this._symbolDataProvider.activeBroker();this._symbolData.calculatePLUsingLast=(null==o?void 0:o.metainfo().configFlags.calculatePLUsingLast)||!1,this._source.positionDisplayMode()!==n.PositionPLDisplay.Money&&this._source.redraw()}async _doActionWithBlock(t,e,o="Chart Position"){if(void 0!==this._callbacks[t]&&null!==this._data){e&&this._source.setIsBlocked(!0);try{await Object(i.ensureDefined)(this._callbacks[t])(o,this._data.id)}catch(r){Z.logWarn(`Try to ${t}, but got error: ${Object(a.errorToString)(r)}`)}finally{e&&(this._source.setIsBlocked(!1),this._source.syncData())}}}}var et=o("972a"),ot=o("HGP3");const it=Object(I.generateColor)(ot.colorsPalette["color-tv-blue-500"],85),rt=Object(I.generateColor)(ot.colorsPalette["color-tv-blue-500"],80),st=Object(I.generateColor)(ot.colorsPalette["color-ripe-red-500"],85),lt=Object(I.generateColor)(ot.colorsPalette["color-ripe-red-500"],80),at=Object(I.generateColor)(ot.colorsPalette["color-minty-green-500"],85),nt=Object(I.generateColor)(ot.colorsPalette["color-minty-green-500"],80),ct=Object(I.generateColor)(ot.colorsPalette["color-tan-orange-500"],85),dt=Object(I.generateColor)(ot.colorsPalette["color-tan-orange-500"],80),ht={buy:{normal:{labelTickColor:ot.colorsPalette["color-tv-blue-500"],lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-a800"],activeColor:it},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:ot.colorsPalette["color-tv-blue-500"],activeColor:it}},disabled:{labelTickColor:ot.colorsPalette["color-tv-blue-500"],lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-a800"],activeColor:it},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:rt,activeColor:it}}},sell:{normal:{labelTickColor:ot.colorsPalette["color-ripe-red-500"],lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],
textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-a800"],activeColor:st},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:ot.colorsPalette["color-ripe-red-500"],activeColor:st}},disabled:{labelTickColor:ot.colorsPalette["color-ripe-red-500"],lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-a800"],activeColor:st},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:lt,activeColor:st}}},takeProfit:{normal:{labelTickColor:ot.colorsPalette["color-minty-green-500"],lineColor:ot.colorsPalette["color-minty-green-500"],borderColor:ot.colorsPalette["color-minty-green-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:"#0D3D41",activeColor:at},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:"#0D3D41"},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:ot.colorsPalette["color-minty-green-500"],activeColor:at}},disabled:{labelTickColor:ot.colorsPalette["color-minty-green-500"],lineColor:ot.colorsPalette["color-minty-green-500"],borderColor:ot.colorsPalette["color-minty-green-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:"#0D3D41",activeColor:at},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:"#0D3D41"},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:nt,activeColor:at}}},stopLoss:{normal:{labelTickColor:ot.colorsPalette["color-tan-orange-500"],lineColor:ot.colorsPalette["color-tan-orange-500"],borderColor:ot.colorsPalette["color-tan-orange-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:"#453826",activeColor:ct},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:"#453826"},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:ot.colorsPalette["color-tan-orange-500"],activeColor:ct}},disabled:{labelTickColor:ot.colorsPalette["color-tan-orange-500"],lineColor:ot.colorsPalette["color-tan-orange-500"],borderColor:ot.colorsPalette["color-tan-orange-500"],qty:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tan-orange-500"],
dividerColor:"#453826",activeColor:ct},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:"#453826"},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:dt,activeColor:ct}}}},ut={buy:{normal:{labelTickColor:ot.colorsPalette["color-tv-blue-500"],lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-50"],activeColor:it},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:ot.colorsPalette["color-tv-blue-500"],activeColor:it}},disabled:{labelTickColor:ot.colorsPalette["color-tv-blue-500"],lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-50"],activeColor:it},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tv-blue-500"],dividerColor:ot.colorsPalette["color-tv-blue-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:rt,activeColor:it}}},sell:{normal:{labelTickColor:ot.colorsPalette["color-ripe-red-500"],lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-50"],activeColor:st},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:ot.colorsPalette["color-ripe-red-500"],activeColor:st}},disabled:{labelTickColor:ot.colorsPalette["color-ripe-red-500"],lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-50"],activeColor:st},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:lt,activeColor:st}}},takeProfit:{normal:{labelTickColor:ot.colorsPalette["color-minty-green-500"],lineColor:ot.colorsPalette["color-minty-green-500"],borderColor:ot.colorsPalette["color-minty-green-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:ot.colorsPalette["color-minty-green-50"],activeColor:at},text:{backgroundColor:ot.colorsPalette["color-white"],
textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:ot.colorsPalette["color-minty-green-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:ot.colorsPalette["color-minty-green-500"],activeColor:at}},disabled:{labelTickColor:ot.colorsPalette["color-minty-green-500"],lineColor:ot.colorsPalette["color-minty-green-500"],borderColor:ot.colorsPalette["color-minty-green-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:ot.colorsPalette["color-minty-green-50"],activeColor:at},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-minty-green-500"],dividerColor:ot.colorsPalette["color-minty-green-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:nt,activeColor:at}}},stopLoss:{normal:{labelTickColor:ot.colorsPalette["color-tan-orange-500"],lineColor:ot.colorsPalette["color-tan-orange-500"],borderColor:ot.colorsPalette["color-tan-orange-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:ot.colorsPalette["color-tan-orange-50"],activeColor:ct},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:ot.colorsPalette["color-tan-orange-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:ot.colorsPalette["color-tan-orange-500"],activeColor:ct}},disabled:{labelTickColor:ot.colorsPalette["color-tan-orange-500"],lineColor:ot.colorsPalette["color-tan-orange-500"],borderColor:ot.colorsPalette["color-tan-orange-500"],qty:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:ot.colorsPalette["color-tan-orange-50"],activeColor:ct},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-tan-orange-500"],dividerColor:ot.colorsPalette["color-tan-orange-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:dt,activeColor:ct}}}};var _t=o("YFKU"),bt=o("//HS");class pt extends W{constructor(){super(...arguments),this._height=19,this._heightBody=19,this._bodyBorderRadius=2,this._lastTextWidth=0}hitTest(t,e){var o;if(null===this._data)return null;const i=e.pixelRatio,r=this._cachedCoordinates(e),s=Math.round(t.x*i),l=Math.round(t.y*i),a=s>=r.reverse.left,n=s<=r.body.right,c=a&&n,d=l>=r.top&&l<=r.bottom,h=Math.round(r.top/i);if(!d||!c)return null;const u={cursorType:L.PaneCursorType.Default,hideCrosshairLinesOnHover:!0,activeItem:{id:this._data.id,part:4}};if(this._data.disabled)return new j.HitTestResult(j.HitTestResult.CUSTOM,u);if(void 0!==(null===(o=this._data)||void 0===o?void 0:o.callbacks.onReverse)){const t=r.reverse.left+r.reverse.width;if(s>=r.reverse.left&&s<t){const t=Math.round(r.reverse.left/i),e=Math.round(r.reverse.width/i);return new j.HitTestResult(j.HitTestResult.CUSTOM,{activeItem:{id:this._data.id,part:3},cursorType:L.PaneCursorType.Default,hideCrosshairLinesOnHover:!0,
contextMenuHandler:this._data.callbacks.onContextMenu,clickHandler:this._data.callbacks.onReverse,tapHandler:this._data.callbacks.onReverse,tooltip:{text:this._data.reverse.title,rect:{x:t,y:h,w:e,h:this._height}}})}if(s>=t&&s<r.body.left)return new j.HitTestResult(j.HitTestResult.CUSTOM,u)}return super.hitTest(t,e)}draw(t,e){var o;if(super.draw(t,e),!(null===(o=this._data)||void 0===o?void 0:o.callbacks.onReverse)||!this._isDataVisibleInViewport(e))return;const i=this._cachedCoordinates(e);this._drawReverseButton(t,e.pixelRatio,i.reverse.left,i.top,i.reverse.width,i.bottom-i.top,i.borderWidth,i.borderRadius)}_drawLinesWithBackground(t,e){var o;if(!(null===(o=this._data)||void 0===o?void 0:o.callbacks.onReverse))return void super._drawLinesWithBackground(t,e);const r=Object(i.ensureNotNull)(this._data),s=e.pixelRatio,l=this._cachedCoordinates(e),a=Math.round(e.physicalWidth),n=l.reverse.left+l.reverse.width;t.save(),t.strokeStyle=r.line.color,t.lineWidth=Math.max(1,Math.floor(r.line.thickness*s)),Object(T.setLineStyle)(t,r.line.style),Object(A.drawHorizontalLine)(t,l.yMid,l.body.right,a),Object(A.drawHorizontalLine)(t,l.yMid,n,l.body.left),r.line.extend&&Object(A.drawHorizontalLine)(t,l.yMid,0,l.reverse.left),t.restore()}_cachedCoordinates(t){return super._cachedCoordinates(t)}_calculateCache(t){const e=super._calculateCache(t),o=Math.round(28*t.pixelRatio),i=e.body.left-o-Math.round(10*t.pixelRatio);return Object.assign(Object.assign({},e),{reverse:{width:o,left:i}})}_calcAllWidth(t,e,o,i,r,s){var l;const a=super._calcAllWidth(t,e,o,i,r,s);if(!(null===(l=this._data)||void 0===l?void 0:l.callbacks.onReverse))return a;return a+Math.round(28*t)+Math.round(10*t)}_textWidth(t){const e=Object(i.ensureNotNull)(this._data);if(!e.text.text)return 0;t.save(),t.font=Object(i.ensureNotNull)(this._font);const o=Math.ceil(this._textWidthCache.measureText(t,e.text.text));if(o>this._lastTextWidth){const e=Math.ceil(this._textWidthCache.measureText(t,"0"));this._lastTextWidth=o+e}return t.restore(),Math.round(14+this._lastTextWidth)}_closeWidth(){return 23}_drawReverseButton(t,e,o,r,s,l,a,n){const c=Object(i.ensureNotNull)(this._data),d=c.reverse,h=d.active;t.save(),Object(A.drawRoundRectWithInnerBorder)(t,o,r,s,l,d.backgroundColor,n,a,c.borderColor),h.visible&&Object(A.drawRoundRectWithInnerBorder)(t,o,r,s,l,h.backgroundColor,n,a,"transparent");const u=Math.round(2*e),_=Math.round(4*e),b=Math.round(7*e),p=Math.round(o+(s-u)/2-_),m=Math.round(p+_+u),v=Math.round(r+6*e),P=v+b,y=d.iconColor;t.lineWidth=a,Object(bt.a)(t,p,v,y,!1,b,_),Object(bt.a)(t,m,P,y,!0,b,_),t.restore()}}const mt=Object(_t.t)("{pips} pips");function vt(t,e,o,r){if(null===e)return"";const s=Object(i.ensureNotNull)(t),l=Math.abs(e),a=o!==n.PositionPLDisplay.Pips?l.toFixed(2):l,c=Object(F.splitThousands)(a," "),d=s>0?"+ "+c:s<0?"− "+c:c;let h;switch(o){case n.PositionPLDisplay.Money:h=r?`${d} ${r}`:d;break;case n.PositionPLDisplay.Pips:h=mt.format({pips:d});break;case n.PositionPLDisplay.Percentage:h=d+"%"}return Object(q.startWithLTR)(h)}
const Pt=Object(v.appendEllipsis)(window.t("Protect Position")),yt=window.t("Reverse Position"),Ct=window.t("Close Position");class gt extends U{constructor(t,e,o,i,r){super(t,e,o,r),this._renderer=new pt,this._showProperty=i}_updateImpl(){if(this._renderer.setData(null),!this._showProperty.value())return;const t=this.priceToCoordinate(this._tradedItem.price());if(null===t)return;const e=this._source.positionDisplayMode(),o=this._styleGetter(),i=o.reverse,r=this.isHoveredSource(),s=r&&this.isActiveItem(),l=(r||this.isSelectedSource())&&this.isActiveItem(),a=s&&this.isActiveItemPart(1),n=s&&this.isActiveItemPart(2),c=s&&this.isActiveItemPart(3);var d,h;this._renderer.setData({fontSize:13,borderColor:o.borderColor,borderStyle:o.borderStyle,y:t,id:this._tradedItem.id(),disabled:this._source.isBlocked(),callbacks:this._callbacks(),line:{thickness:this._source.lineWidth(),width:this._source.lineLength(),style:o.lineStyle,color:o.lineColor,extend:this._source.isLineExtended(),active:{visible:l,backgroundColor:"transparent"}},qty:{title:Pt,text:H(this._tradedItem.qty()),textColor:o.qty.textColor,backgroundColor:o.qty.backgroundColor,dividerColor:o.qty.dividerColor,active:{visible:a,backgroundColor:o.qty.activeColor}},text:{text:vt(this._tradedItem.pl(),this._tradedItem.displayPl(),e,this._tradedItem.currency()),textColor:(d=this._tradedItem.displayPl(),h=o.text,null===d||0===d?h.textColor:d>0?h.positiveTextColor:h.negativeTextColor),backgroundColor:o.text.backgroundColor,dividerColor:o.text.dividerColor},close:{title:Ct,backgroundColor:o.close.backgroundColor,iconColor:o.close.iconColor,active:{visible:n,backgroundColor:o.close.activeColor}},reverse:{title:yt,backgroundColor:i.backgroundColor,iconColor:i.iconColor,active:{visible:c,backgroundColor:i.activeColor}}})}_callbacks(){const t={};return this._tradedItem.supportReverse()&&(t.onReverse=this._tradedItem.onReverse.bind(this._tradedItem)),this._tradedItem.supportClose()&&(t.onClose=this._tradedItem.onClose.bind(this._tradedItem)),this._tradedItem.supportModify()&&(t.onModify=this._tradedItem.onModify.bind(this._tradedItem)),this._tradedItem.hasContextMenu()&&(t.onContextMenu=this._tradedItem.onContextMenu.bind(this._tradedItem)),t}}const xt={buy:{normal:{lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-tv-blue-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-tv-blue-500"],activeColor:ot.colorsPalette["color-tv-blue-600"]},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-cold-gray-600"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-tv-blue-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:ot.colorsPalette["color-tv-blue-500"],activeColor:it},reverse:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],borderColor:ot.colorsPalette["color-tv-blue-500"],
iconColor:ot.colorsPalette["color-tv-blue-500"],activeColor:it}},disabled:{lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-tv-blue-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-tv-blue-500"],activeColor:ot.colorsPalette["color-tv-blue-600"]},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-cold-gray-600"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-tv-blue-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:rt,activeColor:it},reverse:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],borderColor:ot.colorsPalette["color-tv-blue-500"],iconColor:rt,activeColor:it}}},sell:{normal:{lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-ripe-red-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-ripe-red-500"],activeColor:ot.colorsPalette["color-ripe-red-600"]},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-cold-gray-600"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:ot.colorsPalette["color-ripe-red-500"],activeColor:st},reverse:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],borderColor:ot.colorsPalette["color-ripe-red-500"],iconColor:ot.colorsPalette["color-ripe-red-500"],activeColor:st}},disabled:{lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-ripe-red-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-ripe-red-500"],activeColor:ot.colorsPalette["color-ripe-red-600"]},text:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],textColor:ot.colorsPalette["color-cold-gray-600"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-a800"]},close:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],iconColor:lt,activeColor:st},reverse:{backgroundColor:ot.colorsPalette["color-cold-gray-900"],borderColor:ot.colorsPalette["color-ripe-red-500"],iconColor:lt,activeColor:st}}}},wt={buy:{normal:{lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-tv-blue-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-tv-blue-500"],activeColor:ot.colorsPalette["color-tv-blue-600"]},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-cold-gray-300"],
positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-tv-blue-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:ot.colorsPalette["color-tv-blue-500"],activeColor:it},reverse:{backgroundColor:ot.colorsPalette["color-white"],borderColor:ot.colorsPalette["color-tv-blue-500"],iconColor:ot.colorsPalette["color-tv-blue-500"],activeColor:it}},disabled:{lineColor:ot.colorsPalette["color-tv-blue-500"],borderColor:ot.colorsPalette["color-tv-blue-500"],qty:{backgroundColor:ot.colorsPalette["color-tv-blue-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-tv-blue-500"],activeColor:ot.colorsPalette["color-tv-blue-600"]},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-cold-gray-300"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-tv-blue-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:rt,activeColor:ot.colorsPalette["color-tv-blue-50"]},reverse:{backgroundColor:ot.colorsPalette["color-white"],borderColor:ot.colorsPalette["color-tv-blue-500"],iconColor:rt,activeColor:it}}},sell:{normal:{lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-ripe-red-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-ripe-red-500"],activeColor:ot.colorsPalette["color-ripe-red-600"]},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-cold-gray-300"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:ot.colorsPalette["color-ripe-red-500"],activeColor:st},reverse:{backgroundColor:ot.colorsPalette["color-white"],borderColor:ot.colorsPalette["color-ripe-red-500"],iconColor:ot.colorsPalette["color-ripe-red-500"],activeColor:st}},disabled:{lineColor:ot.colorsPalette["color-ripe-red-500"],borderColor:ot.colorsPalette["color-ripe-red-500"],qty:{backgroundColor:ot.colorsPalette["color-ripe-red-500"],textColor:ot.colorsPalette["color-white"],dividerColor:ot.colorsPalette["color-ripe-red-500"],activeColor:ot.colorsPalette["color-ripe-red-600"]},text:{backgroundColor:ot.colorsPalette["color-white"],textColor:ot.colorsPalette["color-cold-gray-300"],positiveTextColor:ot.colorsPalette["color-minty-green-500"],negativeTextColor:ot.colorsPalette["color-ripe-red-500"],dividerColor:ot.colorsPalette["color-ripe-red-50"]},close:{backgroundColor:ot.colorsPalette["color-white"],iconColor:lt,activeColor:st},reverse:{backgroundColor:ot.colorsPalette["color-white"],borderColor:ot.colorsPalette["color-ripe-red-500"],iconColor:lt,activeColor:st}}}};var ft=o("KcY8");class kt extends ft.a{constructor(t,e,o,i,r){super(),
this._model=t,this._data=e,this._source=o,this._showProperty=i,this._styleGetter=r}_updateRendererData(t,e,o){if(t.visible=!1,!this._showProperty.value())return;const i=this._model.mainSeries(),r=i.priceScale(),s=i.firstValue();if(null===s)return;const l=this._data.price();if(null===l)return;const a=this._styleGetter();o.background=a.qty.backgroundColor,o.borderColor=a.labelBorderVisible?a.borderColor:void 0,o.borderStyle=a.labelBorderVisible?a.borderStyle:void 0,o.textColor=a.qty.textColor,o.coordinate=r.priceToCoordinate(l,s),t.borderVisible=a.labelBorderVisible,t.text=this._formatPrice(l),t.tickColor=a.labelTickColor,t.visible=!0}_formatPrice(t){return this._source.priceScaleFormatter().format(t)}}var St=o("TmNs");class Ot extends St.PriceLineAxisView{constructor(t,e,o,i,r,s,l){super(),this._chartModel=t,this._data=e,this._source=o,this._showProperty=s,this._height=i,this._verticalPadding=r,this._styleGetter=l}_value(){const t=this._chartModel.mainSeries(),e=t.firstValue(),o=this._data.price();if(null===o||null===e)return{noData:!0};const i=t.priceScale().priceToCoordinate(o,e);return{noData:!1,floatCoordinate:i,coordinate:i,color:"",formattedPricePercentage:"",formattedPriceAbsolute:"",text:"",index:0}}_updateRendererData(t,e,o){const i=this._styleGetter();t.linestyle=i.lineStyle,o.additionalPaddingTop=this._verticalPadding,o.additionalPaddingBottom=this._verticalPadding,super._updateRendererData(t,e,o)}_priceLineColor(t){return this._styleGetter().lineColor}_lineWidth(){return this._source.lineWidth()}_lineStyle(){return this._styleGetter().lineStyle}_backgroundAreaHeight(){return this._height}_isVisible(){return this._showProperty.value()}}function It(t,e,o){if(o instanceof tt){const i=()=>function(t,e,o){const i=o()?xt:wt,r=t.isBuyDirection()?i.buy:i.sell,s=e.isBlocked()?r.disabled:r.normal;return Object.assign(Object.assign({},s),{lineStyle:e.lineStyle(),borderStyle:et.LineStyle.Solid,labelBorderVisible:!1})}(o,e,()=>t.isDark());return{paneView:new gt(t,o,e,e.showPositionProperty(),i),priceAxisView:new kt(t,o,e,e.showPositionProperty(),i),priceLineAxisView:new Ot(t,o,e,19,0,e.showPositionProperty(),i)}}const i=()=>function(t,e,o){const i=o()?ht:ut;let r;r=t.isBracket()?1===t.type()?i.takeProfit:i.stopLoss:t.isBuyDirection()?i.buy:i.sell;const s=e.isBlocked()?r.disabled:r.normal,l=t.isActive()?e.lineStyle():et.LineStyle.Dotted,a=t.isActive()?et.LineStyle.Solid:et.LineStyle.Dotted;return Object.assign(Object.assign({},s),{lineStyle:l,borderStyle:a,labelBorderVisible:!0})}(o,e,()=>t.isDark());return{paneView:new Q(t,o,e,e.showOrderProperty(),i),priceAxisView:new kt(t,o,e,e.showOrderProperty(),i),priceLineAxisView:new Ot(t,o,e,17,1,e.showOrderProperty(),i)}}class Tt extends d.a{constructor(t,e,o,i,r,s,l){super(t,e),this._symbol=null,this._isActualSymbol=!1,this._blockedData=null,this._isBlocked=!1,this._isDestroyed=!1,this._mainSeries=e.mainSeries(),this._properties=o,this._symbolDataProvider=r;const a=this._mainSeries.dataEvents();a.symbolResolved().subscribe(this,this._updateActualSymbolAndFormatter),
a.symbolError().subscribe(this,this._updateActualSymbolAndFormatter),this._updateActualSymbolAndFormatter(),this._exitTrackingMode=s,this._currencyGetter=l,this._rawDataSpawn=i.spawn(),this._setData(this._rawDataSpawn.value(),!1),this._rawDataSpawn.subscribe(this._setData.bind(this)),this._properties.positionPL.visibility.subscribe(this,this.redraw),this._properties.positionPL.display.subscribe(this,this.redraw)}destroy(){var t;this._properties.showOrders.destroy(),this._properties.showPositions.destroy(),this._properties.positionPL.visibility.unsubscribeAll(this),this._properties.positionPL.display.unsubscribeAll(this);const e=this._mainSeries.dataEvents();e.symbolResolved().unsubscribeAll(this),e.symbolError().unsubscribeAll(this),this._rawDataSpawn.destroy(),null===(t=this._tradedItems.main)||void 0===t||t.destroy(),this._tradedItems.brackets.forEach(t=>t.destroy()),this._isDestroyed=!0}priceScaleFormatter(){return this._mainSeries.formatter()}showPositionProperty(){return this._properties.showPositions}showOrderProperty(){return this._properties.showOrders}lineWidth(){return this._properties.lineProperties.width.value()}lineLength(){return this._properties.lineProperties.length.value()}lineStyle(){return this._properties.lineProperties.style.value()}isLineExtended(){return this._properties.lineProperties.extend.value()}isPositionPLVisible(){return this._properties.positionPL.visibility.value()}positionDisplayMode(){return this._properties.positionPL.display.value()}isBlocked(){return this._isBlocked}setIsBlocked(t){this._isBlocked=t,this.redraw()}mainItem(){return this._tradedItems.main}priceScale(){return this._mainSeries.priceScale()}updateAllViews(){const t=[...this._views.bracketsItems];void 0!==this._views.mainItem&&t.push(this._views.mainItem),void 0!==this._views.stopLimitItem&&t.push(this._views.stopLimitItem);for(const e of t)for(const t of Object.keys(e))e[t].update()}updateViewsForPane(t){this._isSourceShouldBeShown(t)&&this.updateAllViews()}paneViews(t){if(!this._isSourceShouldBeShown(t))return[];const e=[],o=this.activeItemId();let r=null;for(let s=0;s<this._views.bracketsItems.length;s++)Object(i.ensureDefined)(this._tradedItems.brackets[s]).id()===o?r=this._views.bracketsItems[s].paneView:e.push(this._views.bracketsItems[s].paneView);return void 0!==this._views.mainItem&&(Object(i.ensureDefined)(this._tradedItems.main).id()===o?r=this._views.mainItem.paneView:e.push(this._views.mainItem.paneView)),void 0!==this._views.stopLimitItem&&(Object(i.ensureDefined)(this._tradedItems.stopLimit).id()===o?r=this._views.stopLimitItem.paneView:e.push(this._views.stopLimitItem.paneView)),null!==r&&e.push(r),e}priceAxisViews(t,e){if(!this._isSourceShouldBeShown(t))return[];const o=[],r=[],s=this.activeItemId();let l=null,a=null;for(let n=0;n<this._views.bracketsItems.length;n++)Object(i.ensureDefined)(this._tradedItems.brackets[n]).id()===s?(l=this._views.bracketsItems[n].priceAxisView,a=this._views.bracketsItems[n].priceLineAxisView):(o.push(this._views.bracketsItems[n].priceAxisView),
r.push(this._views.bracketsItems[n].priceLineAxisView));return void 0!==this._views.mainItem&&(Object(i.ensureDefined)(this._tradedItems.main).id()===s?(l=this._views.mainItem.priceAxisView,a=this._views.mainItem.priceLineAxisView):(o.push(this._views.mainItem.priceAxisView),r.push(this._views.mainItem.priceLineAxisView))),void 0!==this._views.stopLimitItem&&(Object(i.ensureDefined)(this._tradedItems.stopLimit).id()===s?(l=this._views.stopLimitItem.priceAxisView,a=this._views.stopLimitItem.priceLineAxisView):(o.push(this._views.stopLimitItem.priceAxisView),r.push(this._views.stopLimitItem.priceLineAxisView))),null!==l&&null!==a&&(o.push(l),r.push(a)),t.findTargetPriceAxisViews(this,e,o,r)}redraw(){this.updateAllViews(),this._model.updateSource(this)}isSelectionEnabled(){return!0}syncData(){this._isDestroyed||(null!==this._blockedData?(this._setData(this._blockedData),this._blockedData=null):this._setData(this._rawDataSpawn.value()))}activeItemId(){const t=this._model.lastHittestData()||this._model.customSourceMovingHitTestData();return!this.isHovered()&&!this.isSelected()||null===t||void 0===t.activeItem?null:t.activeItem.id}activePartItem(){const t=this._model.lastHittestData()||this._model.customSourceMovingHitTestData();return!this.isHovered()&&!this.isSelected()||null===t||void 0===t.activeItem?null:t.activeItem.part}isHovered(){return this._model.hoveredSource()===this}isSelected(){return this._model.selection().isSelected(this)}_createMainItem(t){var e,o;let i;return 0===(null===(e=t.main)||void 0===e?void 0:e.mainType)?i=new O(0,t.main,this,this._mainSeries,this._symbolDataProvider,this._exitTrackingMode):1===(null===(o=t.main)||void 0===o?void 0:o.mainType)&&(i=new tt(0,t.main,this,this._symbolDataProvider,this._currencyGetter)),i}_createStopLimitItem(t,e){let o;if(void 0!==t.main&&e instanceof O&&4===e.type()){const e=Object(r.merge)(Object(r.clone)(t.main),{price:t.main.limitPrice,considerFilledQty:!1,isActive:!0});o=new O(1,e,this,this._mainSeries,this._symbolDataProvider,this._exitTrackingMode,!0)}return o}_createItems(t){const e=this._createMainItem(t),o=this._createStopLimitItem(t,e);this._tradedItems={main:e,stopLimit:o,brackets:t.brackets.map((t,e)=>new O(2+e,t,this,this._mainSeries,this._symbolDataProvider,this._exitTrackingMode))}}_createViews(){this._views={bracketsItems:this._tradedItems.brackets.map(t=>It(this._model,this,t))},void 0!==this._tradedItems.main&&(this._views.mainItem=It(this._model,this,this._tradedItems.main)),void 0!==this._tradedItems.stopLimit&&(this._views.stopLimitItem=It(this._model,this,this._tradedItems.stopLimit))}_updateItems(t){if(void 0!==this._tradedItems.main)if(void 0!==t.main)if(this._tradedItems.main instanceof O){if(0!==t.main.mainType)throw new Error("Main item was order");this._tradedItems.main.setData(t.main),void 0!==this._tradedItems.stopLimit&&(4!==t.main.type?(this._tradedItems.main.setData(Object(r.merge)(this._tradedItems.stopLimit.data(),{type:t.main.type,price:t.main.price})),
delete this._tradedItems.stopLimit):this._tradedItems.stopLimit.setData(Object(r.merge)(Object(r.clone)(t.main),{price:t.main.limitPrice})))}else{if(1!==t.main.mainType)throw new Error("Main item was order");this._tradedItems.main.setData(t.main)}else delete this._tradedItems.main;else void 0!==t.main&&(this._tradedItems.main=this._createMainItem(t),this._tradedItems.stopLimit=this._createStopLimitItem(t,this._tradedItems.main));this._tradedItems.brackets.length=t.brackets.length,t.brackets.forEach((t,e)=>{void 0===this._tradedItems.brackets[e]?this._tradedItems.brackets[e]=new O(2+e,t,this,this._mainSeries,this._symbolDataProvider,this._exitTrackingMode):this._tradedItems.brackets[e].setData(t)})}_updateViews(){void 0===this._views.mainItem&&void 0!==this._tradedItems.main?this._views.mainItem=It(this._model,this,this._tradedItems.main):void 0!==this._views.mainItem&&void 0===this._tradedItems.main&&delete this._views.mainItem,void 0===this._views.stopLimitItem&&void 0!==this._tradedItems.stopLimit?this._views.stopLimitItem=It(this._model,this,this._tradedItems.stopLimit):void 0!==this._views.stopLimitItem&&void 0===this._tradedItems.stopLimit&&delete this._views.stopLimitItem,this._views.bracketsItems.length=this._tradedItems.brackets.length,this._tradedItems.brackets.forEach((t,e)=>{void 0===this._views.bracketsItems[e]&&(this._views.bracketsItems[e]=It(this._model,this,t))})}_setData(t,e=!0){var o,i;if(this.isBlocked())return void(this._blockedData=t);e?(this._updateItems(t),this._updateViews()):(this._createItems(t),this._createViews());const r=(null===(o=t.main)||void 0===o?void 0:o.symbol)||(null===(i=t.brackets[0])||void 0===i?void 0:i.symbol)||null;r!==this._symbol&&(this._symbol=r,this._updateActualSymbolAndFormatter()),this.redraw()}_updateActualSymbolAndFormatter(){if(null===this._symbol)return;if(null===this._mainSeries.symbolInfo())this._isActualSymbol=!1;else{const t=this._mainSeries.isConvertedToOtherCurrency()||this._mainSeries.isConvertedToOtherUnit();this._isActualSymbol=!t&&this._mainSeries.symbolSameAsCurrent(this._symbol)}this._updateCurrency(),this.redraw()}_updateCurrency(){null!==this._symbol&&this._isActualSymbol&&this._tradedItems.main instanceof tt&&this._tradedItems.main.updateCurrency(this._symbol)}_isSourceShouldBeShown(t){return!!this._isActualSymbol&&(!!t.containsMainSeries()&&!(window.TradingView.printing&&!h.enabled("snapshot_trading_drawings")))}}o.d(e,"TradedSourcesManager",(function(){return Dt}));const Mt=Object(l.getLogger)("Trading.Order");class Dt{constructor(t,e,o,i){this._ordersData=new Map,this._positionsData=new Map,this._positionsRealToParentIds=new Map,this._tradedSourceData=new Map,this._ordersService=t,this._positionsService=e,this._chartWidgetCollection=o,this._realtimeProvider=i.realtimeProvider,this._brokerCommandsUIGetter=i.brokerCommandsUI,this._trackEvent=i.trackEvent,this._addOrderItems(this._ordersService.activeOrders()),this._ordersService.activeOrdersUpdated().subscribe(this,t=>this._addOrderItems([t])),
this._ordersService.activeOrdersRemoved().subscribe(this,this._removeTradedSources),this._addPositionItems(this._positionsService.positions()),this._positionsService.positionUpdate().subscribe(this,t=>this._addPositionItems([t])),this._positionsService.positionsRemoved().subscribe(this,this._removeTradedSources)}destroy(){this._ordersService.activeOrdersUpdated().unsubscribeAll(this),this._ordersService.activeOrdersRemoved().unsubscribeAll(this),this._ordersData.clear(),this._tradedSourceData.clear()}_getBrackets(t){const e=[];if(!this._ordersData.has(t)){const e=this._positionsRealToParentIds.get(t);void 0!==e&&(t=e)}return this._ordersData.forEach(o=>{o.parentId===t&&e.push(Object(r.merge)(Object(r.clone)(o),{callbacks:this._createCallbacksForOrder(o)}))}),e}_createTradedSourceData(t){let e;const o=this._ordersData.get(t),i=this._positionsData.get(t);return void 0!==o?e=Object(r.merge)(Object(r.clone)(o),{mainType:0,callbacks:this._createCallbacksForOrder(o)}):void 0!==i&&(e=Object(r.merge)(Object(r.clone)(i),{mainType:1,callbacks:this._createCallbacksForPosition()})),{main:e,brackets:this._getBrackets(t)}}_recreateTradedSource(t){const e=this._createTradedSourceData(t),o=this._tradedSourceData.get(t);if(void 0!==o)o.setValue(e);else{const o=new s.WatchedObject(e);i=this._chartWidgetCollection,r=this._realtimeProvider,l=t,a=o,d=this._positionsService.getCurrency.bind(this._positionsService),i.addCustomSource("traded"+l,(t,e)=>{const o=e.properties().childs().tradingProperties.childs(),s=Object(c.b)(e.isInReplay.bind(e),e.onInReplayStateChanged()),l=Object(c.a)((t,e)=>e=e&&!t,s,o.showOrders),n=Object(c.a)((t,e)=>e=e&&!t,s,o.showPositions),h={lineProperties:{width:o.lineWidth,length:o.lineLength,style:o.lineStyle,extend:o.extendLeft},showOrders:l,showPositions:n,positionPL:o.positionPL.childs()};return new Tt(t,e,h,a,r,()=>i.activeChartWidget.value().exitTrackingMode(),d)},n.CustomSourceLayer.Topmost),this._tradedSourceData.set(t,o)}var i,r,l,a,d}async _findPositionRealIdByParentId(t){const e=this._positionsData.get(t);let o;if(void 0!==e)o=e.id;else if(o=await this._positionsService.realIdFromBroker(t),null===o){const e=this._currentRealPositionIdByParentId(t);return null!==e&&this._positionsRealToParentIds.delete(e),null}return this._positionsRealToParentIds.set(o,t),o}_currentRealPositionIdByParentId(t){for(const e of Array.from(this._positionsRealToParentIds.keys()))if(this._positionsRealToParentIds.get(e)===t)return e;return null}async _findAndUpdateParentPosition(t,e=!1){const o=this._currentRealPositionIdByParentId(t),i=await this._findPositionRealIdByParentId(t);if(null!==o&&null===i&&this._tradedSourceData.has(o)&&this._recreateTradedSource(o),null===o&&null!==i){const e=this._tradedSourceData.get(t);void 0!==e&&void 0===e.value().main&&this._removeTradedSources([t])}e&&o===i||this._recreateTradedSource(i||t)}_addOrderItems(t){for(const e of t){this._removeSourceIfChangedParent(e),this._ordersData.set(e.id,e);const t=void 0!==e.parentId?e.parentId:e.id
;if(2===e.parentType||3===e.parentType)return void this._findAndUpdateParentPosition(t);this._recreateTradedSource(t)}}_addPositionItems(t){for(const e of t){const t=e.id;this._positionsData.set(t,e),this._recreateTradedSource(t);this._ordersService.activeOrders().filter(t=>1!==t.parentType&&void 0!==t.parentType&&t.symbol===e.symbol).forEach(t=>{this._findAndUpdateParentPosition(t.parentId,!0)})}}_removeSourceIfChangedParent(t){const e=this._ordersData.get(t.id);void 0===e||e.parentId===t.parentId&&e.parentType===t.parentType||this._removeTradedSources([e.id])}_removeTradedSources(t){for(const i of t)if(this._tradedSourceData.has(i))e=this._chartWidgetCollection,o=i,e.removeCustomSource("traded"+o),this._positionsData.delete(i),this._ordersData.delete(i),this._tradedSourceData.delete(i);else{const t=this._ordersData.get(i);if(void 0!==t)if(this._ordersData.delete(i),1===t.parentType)this._recreateTradedSource(t.parentId);else{const e=this._currentRealPositionIdByParentId(t.parentId);this._recreateTradedSource(e||t.parentId)}}var e,o}_createCallbacksForOrder(t){const e={cancelOrder:this._cancelOrder.bind(this)};return t.supportModify&&(e.modifyOrder=this._modifyOrder.bind(this),e.moveOrder=this._moveOrder.bind(this)),e}_createCallbacksForPosition(){return{reversePosition:this._reversePosition.bind(this),modifyPosition:this._modifyPosition.bind(this),closePosition:this._closePosition.bind(this)}}async _processingModifyOrder(t,e,o){let r;4===o.type&&(t.useLimitPrice||(r=2),t.useStopPrice||(r=1));let s=!1;try{s=await Object(i.ensureNotNull)(this._brokerCommandsUIGetter()).modifyOrder(e,t.silent,r)}catch(l){Mt.logError("Try to modify order with error "+Object(a.errorToString)(l))}return s}_modifyOrder(t,e,o,r=!1){this._trackEvent(t,"Edit Order");const s={useLimitPrice:r},l=Object(i.ensureNotNull)(this._ordersService.find(e));return this._processingModifyOrder(s,o,l)}_moveOrder(t,e,o,r=!1){this._trackEvent(t,"Move Order");const s={silent:!0};r?s.useLimitPrice=!0:s.useStopPrice=Boolean(o.stopPrice);const l=Object(i.ensureNotNull)(this._ordersService.find(e));return this._processingModifyOrder(s,o,l)}_cancelOrder(t,e){return this._trackEvent(t,"Cancel Order"),Object(i.ensureNotNull)(this._brokerCommandsUIGetter()).cancelOrder(e)}_reversePosition(t,e){return this._trackEvent(t,"Reverse Position"),Object(i.ensureNotNull)(this._brokerCommandsUIGetter()).reversePosition(e)}_modifyPosition(t,e){this._trackEvent(t,"Edit Position");const o=Object(i.ensureNotNull)(this._brokerCommandsUIGetter());return this._positionsService.isDisplayModeTrades()?Object(i.ensureDefined)(o.editTradeBrackets).call(o,e):o.editPositionBrackets(e,{})}_closePosition(t,e){this._trackEvent(t,"Close Position");const o=Object(i.ensureNotNull)(this._brokerCommandsUIGetter());return this._positionsService.isDisplayModeTrades()?o.closeTrade(e):o.closePosition(e)}}},bydf:function(t,e,o){"use strict";o.r(e);var i=o("Eyy1"),r=o("ogJP"),s=o("KtbP"),l=o("oV8k"),a=o("TmNs");class n extends a.PriceLineAxisView{constructor(t,e,o){super(),this._model=t,this._source=e,
this._priceType=o}_value(){const t=this._model.mainSeries(),e=t.priceScale(),o=t.firstValue();if(null===o)return{noData:!0};const i=this._source.getPrice(this._priceType);if(null===i)return{noData:!0};const r=e.priceToCoordinate(i,o);return{noData:!1,floatCoordinate:r,coordinate:r,color:"",formattedPricePercentage:"",formattedPriceAbsolute:"",text:"",index:0}}_priceLineColor(t){const e=this._source.properties().childs();return 0===this._priceType?e.bidLineColor.value():e.askLineColor.value()}_lineWidth(){return this._source.properties().childs().lineWidth.value()}_lineStyle(){return this._source.properties().childs().lineStyle.value()}_isVisible(){return this._source.properties().childs().visible.value()}}var c=o("YFKU"),d=o("KcY8");class h extends d.a{constructor(t,e,o){super(),this._model=t,this._source=e,this._priceType=o}_updateRendererData(t,e,o){if(t.visible=!1,e.visible=!1,!this._model.properties().scalesProperties.showBidAskLabels.value())return;const i=this._model.mainSeries(),r=i.priceScale(),s=i.firstValue();if(null===s)return;const l=this._source.getPrice(this._priceType);if(null===l)return;t.visible=!0,e.visible=!0,t.text=r.formatPriceAbsolute(l),e.text=0===this._priceType?Object(c.t)("Bid"):Object(c.t)("Ask"),o.coordinate=r.priceToCoordinate(l,s);const a=this._source.properties().childs();o.background=0===this._priceType?a.bidLineColor.value():a.askLineColor.value()}}var u=o("2ijp"),_=o("VdBB");class b extends u.a{constructor(t,e,o,i){super(),this._model=t,this._source=e,this._priceType=o;const r={doubleClickHandler:i,doubleTapHandler:i};this._lineRenderer.setHitTest(new _.HitTestResult(_.HitTestResult.REGULAR,r))}_updateImpl(){const t=this._lineRendererData;t.visible=!1;const e=this._source.properties().childs();if(!e.visible.value())return;const o=this._model.mainSeries(),i=o.priceScale(),r=o.firstValue();if(null===r)return;const s=this._source.getPrice(this._priceType);null!==s&&(t.visible=!0,t.y=i.priceToCoordinate(s,r),t.linestyle=e.lineStyle.value(),t.linewidth=e.lineWidth.value(),t.color=0===this._priceType?e.bidLineColor.value():e.askLineColor.value())}}o.d(e,"BidAsk",(function(){return p}));class p extends l.a{constructor(t,e,o,i){super(t,e),this._ask=null,this._bid=null,this._symbol=null,this._realtimeProvider=o,this._bidLinesPaneView=new b(e,this,0,i),this._askLinesPaneView=new b(e,this,1,i),this._bidPriceAxisView=new h(e,this,0),this._askPriceAxisView=new h(e,this,1),this._regularPriceAxisViews=[this._bidPriceAxisView,this._askPriceAxisView],this._bidLabelPaneView=new s.PanePriceAxisView(this._bidPriceAxisView,e.mainSeries(),e),this._askLabelPaneView=new s.PanePriceAxisView(this._askPriceAxisView,e.mainSeries(),e),this._bidPriceLineAxisView=new n(e,this,0),this._askPriceLineAxisView=new n(e,this,1),this._externalPriceAxisViews=[this._bidPriceLineAxisView,this._askPriceLineAxisView],this._updateRealtimeDataHandler=this._updateRealtimeData.bind(this);const r=e.mainSeries().dataEvents();r.symbolResolved().subscribe(this,this._createTradedSymbol),
r.symbolError().subscribe(this,this._createTradedSymbol),this._createTradedSymbol()}destroy(){const t=this._model.mainSeries().dataEvents();t.symbolResolved().unsubscribeAll(this),t.symbolError().unsubscribeAll(this),this._clearTradedSymbol()}paneViews(t){return this._isMainSourcePane(t)?[this._bidLinesPaneView,this._askLinesPaneView]:[]}labelPaneViews(t){return this._isMainSourcePane(t)?[this._bidLabelPaneView,this._askLabelPaneView]:[]}priceAxisViews(t,e){return this._isMainSourcePane(t)?t.findTargetPriceAxisViews(this,e,this._regularPriceAxisViews,this._externalPriceAxisViews):[]}priceScale(){return this._model.mainSeries().priceScale()}updateAllViews(){this._bidLinesPaneView.update(),this._askLinesPaneView.update(),this._bidPriceAxisView.update(),this._askPriceAxisView.update(),this._bidPriceLineAxisView.update(),this._askPriceLineAxisView.update(),this._bidLabelPaneView.update(),this._askLabelPaneView.update()}getPrice(t){return 1===t?this._ask:this._bid}properties(){return this._model.mainSeries().properties().bidAsk}_createTradedSymbol(){const t=function(t){if(t.isConvertedToOtherCurrency()||t.isConvertedToOtherUnit())return null;const e=t.symbolInfo();return null===e?t.proSymbol():e.pro_name||null}(this._model.mainSeries());t!==this._symbol&&(this._clearTradedSymbol(),null!==t&&this._initTradedSymbol(t))}_initTradedSymbol(t){this._symbol=t,this._realtimeProvider.subscribeRealtime(this._symbol,this._updateRealtimeDataHandler)}_clearTradedSymbol(){this._ask=null,this._bid=null,null!==this._symbol&&(this._realtimeProvider.unsubscribeRealtime(Object(i.ensureNotNull)(this._symbol),this._updateRealtimeDataHandler),this._symbol=null)}_updateRealtimeData(t,e,o){const i=e.ask,s=e.bid;i===s?(this._ask=null,this._bid=null):(Object(r.isNumber)(i)&&(this._ask=i),Object(r.isNumber)(s)&&(this._bid=s)),(this._model.mainSeries().properties().bidAsk.visible.value()||this._model.properties().scalesProperties.showBidAskLabels.value())&&(this.updateAllViews(),this._model.updateSource(this))}_isMainSourcePane(t){return this._model.paneForSource(this._model.mainSeries())===t}}},"fA+p":function(t,e,o){"use strict";o.r(e),o.d(e,"ExecutionsService",(function(){return d}));var i=o("Eyy1"),r=o("ogJP"),s=o("kcTO"),l=o("2TBc"),a=o("aIyQ"),n=o.n(a),c=o("4qhP");class d extends l.a{constructor(t,e,o){super(t),this._allExecutionsID=new Set,this._executions=[],this._executionsAdded=new n.a,this._executionsCleared=new n.a,this._formatter=new s.PriceFormatter,this._symbol="",this._dataEvents=e,this._getSymbolName=o,this._initialized=!0,this._tryToStart()}destroy(){this.stopService()}formatter(){return this._formatter}executions(){return this._executions}executionsAdded(){return this._executionsAdded}executionsCleared(){return this._executionsCleared}startService(){var t;(null===(t=this.activeBroker())||void 0===t?void 0:t.config.supportExecutions)&&(this._canBeStarted=!0,this._tryToStart())}stopService(){this._canBeStarted=!1,this._isStarted&&this._stop()}_tryToStart(){Object(i.assert)(!this._isStarted,"Execution's service has already started"),
this._canBeStarted&&this._initialized&&this._start()}_start(){Object(i.assert)(!this._isStarted,"Execution's service has already started"),this._isStarted=!0,this._dataEvents.symbolResolved().subscribe(this,this._createExecutions),this._dataEvents.symbolError().subscribe(this,this._createExecutions),this._createExecutions()}_stop(){this._isStarted=!1,this._clearExecutions();Object(i.ensure)(this.activeBroker()).executionUpdate.unsubscribeAll(this),this._dataEvents.symbolResolved().unsubscribeAll(this),this._dataEvents.symbolError().unsubscribeAll(this)}_createExecutions(){this._clearExecutions(),this._symbol=this._getSymbolName(),this._symbol&&this._requestFormatterAndExecutions()}_clearExecutions(){this._allExecutionsID=new Set,this._executions=[],this._executionsCleared.fire()}async _requestFormatterAndExecutions(){const t=this.activeBroker();if(!t)return;if(!this._symbol)return;if(!(await t.isTradable(this._symbol)).tradable)return;const e=this._symbol;Promise.all([t.formatter(this._symbol,!1),t.executions(this._symbol)]).then(([o,i])=>{this._symbol===e&&(this._formatter=o,this._executions=i.map(t=>this._createExecutionData(t)).filter(r.notNull),this._executionsAdded.fire(this._executions),t.executionUpdate.unsubscribeAll(this),t.executionUpdate.subscribe(this,this._addExecution))})}_addExecution(t){const e=this._createExecutionData(t);null!==e&&this._executionsAdded.fire([e])}_createExecutionData(t){return t.symbol!==this._symbol||this._allExecutionsID.has(t.id)?null:(this._allExecutionsID.add(t.id),Object.assign(Object.assign({},t),{tooltip:Object(c.d)(t,this._formatter)}))}}}}]);